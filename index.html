<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†ç§‘æ¸¬é©—å¿—é¡˜è½é»åˆ†æ</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background: #f5f7fa;
            color: #2c3e50;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 20px;
            color: #1a4d8c;
            border-left: 6px solid #1a4d8c;
            padding-left: 20px;
        }

        h2 {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        /* æˆç¸¾è¼¸å…¥å€åŸŸ */
        .score-panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .score-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .score-item {
            flex: 1 1 120px;
            min-width: 120px;
            display: flex;
            flex-direction: column;
        }

        .score-item label {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 5px;
            color: #4a5568;
        }

        .score-item input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            text-align: left;
            transition: all 0.2s;
            height: 45px;
        }

        .score-item input:focus {
            outline: none;
            border-color: #1a4d8c;
            box-shadow: 0 0 0 3px rgba(26,77,140,0.2);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            height: 45px;
        }

        .btn-primary {
            background: #1a4d8c;
            color: white;
        }

        .btn-primary:hover {
            background: #0d3a6f;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #2c3e50;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .filter-stats {
            background: #e6f3ff;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            color: #1a4d8c;
            font-size: 0.95rem;
        }

        /* æ§åˆ¶åˆ— */
        .control-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        .year-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .year-btn {
            padding: 8px 16px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            height: 45px;
        }

        .year-btn.active {
            background: #1a4d8c;
            border-color: #1a4d8c;
            color: white;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 30px;
            font-size: 1rem;
            height: 45px;
        }

        /* ç§‘ç³»åˆ—è¡¨ */
        .dept-list {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }

        .list-header {
            display: grid;
            grid-template-columns: 3fr 2fr 1fr 1fr 0.8fr;
            background: #f8fafc;
            padding: 15px 20px;
            font-weight: 700;
            border-bottom: 2px solid #e2e8f0;
        }

        .dept-row {
            display: grid;
            grid-template-columns: 3fr 2fr 1fr 1fr 0.8fr;
            padding: 15px 20px;
            border-bottom: 1px solid #e2e8f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .dept-row:hover {
            background: #f1f5f9;
        }

        .dept-row.expanded {
            background: #e6f0ff;
            border-bottom: none;
        }

        .dept-detail {
            grid-column: 1 / -1;
            background: #f8fafc;
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
        }

        .gap-value {
            font-weight: 700;
        }

        .gap-positive {
            color: #c0392b;
        }

        .gap-negative {
            color: #27ae60;
        }

        .add-btn {
            background: #1a4d8c;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 5px 7px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            min-height: 35px;
            max-height: 51px;
        }

        .add-btn:hover {
            background: #0d3a6f;
        }

        .add-btn.added {
            background: #95a5a6;
            cursor: default;
        }

        .add-btn.added:hover {
            background: #95a5a6;
        }

        /* æˆ‘çš„æ¸…å–® */
        .favorites-panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-top: 30px;
        }

        .favorites-list {
            margin-top: 20px;
        }

        .favorite-item {
            display: grid;
            grid-template-columns: 2fr 1.5fr 1fr 1fr 0.5fr;
            align-items: center;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .favorite-detail {
            grid-column: 1 / -1;
            margin-top: 10px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .remove-btn {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 5px 10px;
            cursor: pointer;
            min-height: 35px;
            max-height: 51px;
        }

        .remove-btn:hover {
            background: #c0392b;
        }

        .calc-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .calc-table th, .calc-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .subject-tag {
            display: inline-block;
            background: #e2e8f0;
            padding: 2px 6px;
            border-radius: 4px;
            margin: 2px;
            font-size: 0.85rem;
        }

        .missing-subjects {
            margin-top: 10px;
            padding: 10px;
            background: #fff3cd;
            border-radius: 6px;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š åˆ†ç§‘æ¸¬é©—å¿—é¡˜è½é»åˆ†æ</h1>

        <div class="btn-group" style="margin-bottom: 20px;">
            <button id="tab-analysis" class="year-btn active" onclick="showPage('analysis')">ğŸ è½é»åˆ†æ</button>
            <button id="tab-favorites" class="year-btn" onclick="showPage('favorites')">â­ æŸ¥çœ‹æ¸…å–®</button>
        </div>

        <div id="page-analysis">
             <!-- æˆç¸¾è¼¸å…¥å€ -->
            <div class="score-panel">
                <h2>ğŸ“ è¼¸å…¥ä½ çš„æˆç¸¾</h2>
                <div class="filter-stats">
                    <strong>â„¹ï¸ ä½¿ç”¨èªªæ˜ï¼š</strong><br>
                    â€¢ å·²æœ‰æˆç¸¾ â†’ å¡«å…¥å¯¦éš›åˆ†æ•¸<br>
                    â€¢ æ‰“ç®—è¦è€ƒçš„ç§‘ç›® â†’ å¡«å…¥ 0ï¼ˆè¡¨ç¤ºä¹‹å¾Œæœƒè€ƒï¼‰<br>
                    â€¢ ä¸æ‰“ç®—è€ƒçš„ç§‘ç›® â†’ ç•™ç©ºç™½ï¼ˆè©²ç§‘ç³»æœƒè¢«ç¯©é¸æ‰ï¼‰
                </div>
                
                <!-- ç¬¬ä¸€è¡Œï¼šåœ‹æ–‡ è‹±æ–‡ æ•¸A æ•¸B ç¤¾æœƒ è‡ªç„¶ -->
                <div class="score-row" id="scoreRow1"></div>
                
                <!-- ç¬¬äºŒè¡Œï¼šæ•¸ç”² æ•¸ä¹™ åœ°ç† æ­·å² å…¬æ°‘ ç‰©ç† åŒ–å­¸ ç”Ÿç‰© -->
                <div class="score-row" id="scoreRow2"></div>
                
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="resetScores()">æ¸…é™¤æ‰€æœ‰æˆç¸¾</button>
                </div>
            </div>

            <!-- ä¸»è¦ç€è¦½å€ -->
            <div class="control-bar">
                <div class="year-selector" id="yearSelector"></div>

                <div class="year-selector">
                    <button id="type-all" class="year-btn active" onclick="filterByType('all')">å…¨éƒ¨å­¸æ ¡</button>
                    <button id="type-public" class="year-btn" onclick="filterByType('public')">å…¬ç«‹å¤§å­¸</button>
                    <button id="type-private" class="year-btn" onclick="filterByType('private')">ç§ç«‹å¤§å­¸</button>
                </div>
                
                <button id="passFilterBtn" class="year-btn" onclick="togglePassFilter()">
                    é¡¯ç¤ºå…¨éƒ¨
                </button>

                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="ğŸ” æœå°‹å­¸æ ¡æˆ–ç§‘ç³»åç¨±..." oninput="filterDepartments()">
                </div>
            </div>

            <!-- ç§‘ç³»åˆ—è¡¨ -->
            <div class="dept-list" id="deptList">
                <div class="list-header">
                    <div>æ ¡ç³»åç¨±</div>
                    <div>æ¡è¨ˆç§‘ç›®</div>
                    <div>æœ€ä½éŒ„å–</div>
                    <div>é ä¼°å·®è·</div>
                    <div>æ“ä½œ</div>
                </div>
                <div id="deptRows"></div>
            </div>
        </div>

        <div id="page-favorites" style="display: none;">
            <div class="favorites-panel">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                    <h2>â­ æˆ‘çš„è¿½è¹¤æ¸…å–® (å…± <span id="favoritesCount">0</span> å€‹)</h2>
                    
                    <div class="search-box" style="max-width: 300px; flex: 1;">
                        <input type="text" id="favSearchInput" placeholder="ğŸ” åœ¨æ”¶è—ä¸­æœå°‹..." oninput="renderFavorites()">
                    </div>
                </div>
                
                <div id="favoritesList" class="favorites-list"></div>
            </div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let allData = {};
        let currentYear = '114';
        let userScores = {};
        let favorites = [];
        let expandedRows = new Set();
        let favExpandedRows = new Set();
        let showOnlyPass = false;
        let currentType = 'all';

        // ç§‘ç›®é †åº
        const subjectRows = {
            row1: ['åœ‹æ–‡', 'è‹±æ–‡', 'æ•¸A', 'æ•¸B', 'ç¤¾æœƒ', 'è‡ªç„¶'],
            row2: ['æ•¸ç”²', 'æ•¸ä¹™', 'åœ°ç†', 'æ­·å²', 'å…¬æ°‘', 'ç‰©ç†', 'åŒ–å­¸', 'ç”Ÿç‰©']
        };

        // åŸºç¤ç§‘ç›®ï¼ˆç”¨æ–¼åˆ¤æ–·æ˜¯å¦è¦é¡¯ç¤ºè©³ç´°ï¼‰
        const basicSubjects = ['åœ‹æ–‡', 'è‹±æ–‡', 'æ•¸A', 'æ•¸B', 'ç¤¾æœƒ', 'è‡ªç„¶'];

        // ç§‘ç›®æ­£è¦åŒ–
        function normalizeSubject(subject) {
            const map = {
                'åœ‹': 'åœ‹æ–‡', 'åœ‹æ–‡': 'åœ‹æ–‡',
                'è‹±': 'è‹±æ–‡', 'è‹±æ–‡': 'è‹±æ–‡',
                'æ•¸ç”²': 'æ•¸ç”²', 'æ•¸A': 'æ•¸A',
                'æ•¸ä¹™': 'æ•¸ä¹™', 'æ•¸B': 'æ•¸B',
                'ç‰©': 'ç‰©ç†', 'ç‰©ç†': 'ç‰©ç†',
                'åŒ–': 'åŒ–å­¸', 'åŒ–å­¸': 'åŒ–å­¸',
                'ç”Ÿ': 'ç”Ÿç‰©', 'ç”Ÿç‰©': 'ç”Ÿç‰©',
                'æ­·': 'æ­·å²', 'æ­·å²': 'æ­·å²',
                'åœ°': 'åœ°ç†', 'åœ°ç†': 'åœ°ç†',
                'å…¬': 'å…¬æ°‘', 'å…¬æ°‘': 'å…¬æ°‘',
                'è‡ªç„¶': 'è‡ªç„¶', 'è‡ª': 'è‡ªç„¶',
                'ç¤¾æœƒ': 'ç¤¾æœƒ', 'ç¤¾': 'ç¤¾æœƒ'
            };
            return map[subject] || subject;
        }

        // è§£ææ¡è¨ˆå­—ä¸²
        function parseWeightString(weightStr) {
            if (!weightStr) return {};
            const weights = {};
            const matches = weightStr.matchAll(/([^\sx]+)x([0-9.]+)/g);
            for (const match of matches) {
                weights[match[1]] = parseFloat(match[2]);
            }
            return weights;
        }

        // æª¢æŸ¥æ˜¯å¦è©²é¡¯ç¤ºç§‘ç³»
        function shouldShowDept(weights) {
            for (const subject of Object.keys(weights)) {
                const normSubject = normalizeSubject(subject);
                if (userScores[normSubject] === undefined) {
                    return false;
                }
            }
            return true;
        }

        // åˆå§‹åŒ–
        async function init() {
            try {
                document.getElementById('deptRows').innerHTML = '<div class="loading">ğŸ“‚ è¼‰å…¥è³‡æ–™ä¸­...</div>';
                
                const savedScores = localStorage.getItem('userScores');
                if (savedScores && savedScores !== '{}') {
                    userScores = JSON.parse(savedScores);
                } else {
                    userScores = {
                        'åœ‹æ–‡': 41, 'è‹±æ–‡': 21, 'æ•¸B': 21, 'ç¤¾æœƒ': 37,
                        'æ•¸ä¹™': 41, 'åœ°ç†': 41, 'æ­·å²': 41, 'å…¬æ°‘': 41
                    };
                }

                const years = ['114', '113', '112', '111'];
                for (const year of years) {
                    try {
                        const response = await fetch(`${year}.json`);
                        if (!response.ok) throw new Error(`æ‰¾ä¸åˆ° ${year}.json`);
                        allData[year] = await response.json();
                    } catch (err) {
                        console.warn(`è·³éè®€å– ${year}.json:`, err);
                    }
                }

                // æª¢æŸ¥æ˜¯å¦è‡³å°‘æœ‰ä¸€å¹´è³‡æ–™è¼‰å…¥æˆåŠŸ
                if (Object.keys(allData).length === 0) {
                    throw new Error('æ‰€æœ‰å¹´ä»½çš„è³‡æ–™è¼‰å…¥éƒ½å¤±æ•—äº†ï¼Œè«‹æª¢æŸ¥ JSON æª”æ¡ˆæ˜¯å¦å­˜åœ¨ã€‚');
                }

                generateYearButtons();
                generateScoreInputs();
                loadFavorites();
                renderFavorites(); 
                renderDeptList(currentYear);
                
            } catch (error) {
                console.error('è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
                document.getElementById('deptRows').innerHTML = `<div class="no-data">âŒ è¼‰å…¥å¤±æ•—: ${error.message}</div>`;
            }
        }

        // ç”¢ç”Ÿå¹´ä»½æŒ‰éˆ•
        function generateYearButtons() {
            const container = document.getElementById('yearSelector');
            const years = ['114', '113', '112', '111'];
            container.innerHTML = years.map(year => `
                <button class="year-btn ${year === currentYear ? 'active' : ''}" 
                        onclick="switchYear('${year}')">
                    ${year} å­¸å¹´åº¦
                </button>
            `).join('');
        }

        function switchYear(year) {
            currentYear = year;
            generateYearButtons();
            renderDeptList(currentYear);
        }

        // ç”¢ç”Ÿè¼¸å…¥æ¬„ä½
        function generateScoreInputs() {
            const row1Container = document.getElementById('scoreRow1');
            row1Container.innerHTML = subjectRows.row1.map(subject => `
                <div class="score-item">
                    <label>${subject}</label>
                    <input type="number" 
                           id="score-${subject}" 
                           value="${userScores[subject] !== undefined ? userScores[subject] : ''}" 
                           placeholder="è¼¸å…¥åˆ†æ•¸"
                           min="0" max="100" 
                           step="0.1"
                           onchange="updateScore('${subject}', this.value)">
                </div>
            `).join('');

            const row2Container = document.getElementById('scoreRow2');
            row2Container.innerHTML = subjectRows.row2.map(subject => `
                <div class="score-item">
                    <label>${subject}</label>
                    <input type="number" 
                           id="score-${subject}" 
                           value="${userScores[subject] !== undefined ? userScores[subject] : ''}" 
                           placeholder="è¼¸å…¥åˆ†æ•¸"
                           min="0" max="100" 
                           step="0.1"
                           onchange="updateScore('${subject}', this.value)">
                </div>
            `).join('');
        }

        function updateScore(subject, value) {
            if (value === '') {
                delete userScores[subject];
            } else {
                userScores[subject] = parseFloat(value);
            }
            localStorage.setItem('userScores', JSON.stringify(userScores));
            renderDeptList(currentYear);
        }

        function resetScores() {
            userScores = {};
            generateScoreInputs();
            renderDeptList(currentYear);
            renderFavorites();
        }

        function updateAllCalculations() {
            renderDeptList(currentYear);
            renderFavorites();
        }

        function filterDepartments() {
            renderDeptList(currentYear);
        }

        // è¨ˆç®—å·®è·
        function calculateGap(dept) {
            const weights = parseWeightString(dept["æ¡è¨ˆåŠåŠ æ¬Š"]);
            let myTotal = 0;
            
            for (const [subject, weight] of Object.entries(weights)) {
                const normSubject = normalizeSubject(subject);
                const score = userScores[normSubject] || 0;
                myTotal += score * weight;
            }
            
            return dept["æ™®é€šç”ŸéŒ„å–åˆ†æ•¸"] - myTotal;
        }

        // å–å¾—éœ€è¦è£œè¶³çš„ç§‘ç›®ï¼ˆæ’é™¤åŸºç¤ç§‘ç›®ï¼‰
        function getMissingSubjects(dept) {
            const weights = parseWeightString(dept["æ¡è¨ˆåŠåŠ æ¬Š"]);
            const missing = [];
            
            for (const [subject, weight] of Object.entries(weights)) {
                const normSubject = normalizeSubject(subject);
                // å¦‚æœä¸æ˜¯åŸºç¤ç§‘ç›®ï¼Œè€Œä¸”åˆ†æ•¸æ˜¯0
                if (!basicSubjects.includes(normSubject) && (userScores[normSubject] === 0)) {
                    missing.push({ subject, weight });
                }
            }
            
            return missing;
        }

        // æ ¼å¼åŒ–ç§‘ç›®é¡¯ç¤º
        function formatSubjects(weightStr) {
            if (!weightStr) return 'ç„¡æ¡è¨ˆè³‡æ–™';
            const parts = weightStr.split(' ');
            return parts.map(p => {
                if (!p) return '';
                const match = p.match(/([^\sx]+)x([0-9.]+)/);
                if (match) {
                    return `<span class="subject-tag">${match[1]} x${match[2]}</span>`;
                }
                return '';
            }).join('');
        }

        // ç”¢ç”Ÿè©³ç´° HTML
        // ä¿®æ”¹å¾Œçš„è©³ç´°è¨ˆç®—é‚è¼¯
        function generateDetailHTML(dept, showMissingOnly = false) {
            const weights = parseWeightString(dept["æ¡è¨ˆåŠåŠ æ¬Š"]);
            let usedHTML = '';
            let myTotal = 0;
            
            // ç”¨æ–¼è¨ˆç®—åˆ†ç§‘ç›®æ¨™çš„è®Šæ•¸
            let gsatedWeightedSum = 0; // å­¸æ¸¬åŠ æ¬Šç¸½åˆ†
            let electiveWeightSum = 0; // åˆ†ç§‘åŠ æ¬Šå€ç‡ç¸½å’Œ
            const gsateSubjects = ['åœ‹æ–‡', 'è‹±æ–‡', 'æ•¸A', 'æ•¸B', 'ç¤¾æœƒ', 'è‡ªç„¶'];

            for (const [subject, weight] of Object.entries(weights)) {
                const normSubject = normalizeSubject(subject);
                const score = userScores[normSubject] || 0;
                const weighted = score * weight;
                myTotal += weighted;

                // åˆ¤æ–·æ˜¯å­¸æ¸¬é‚„æ˜¯åˆ†ç§‘ç§‘ç›®
                const isGSAT = gsateSubjects.includes(normSubject);
                if (isGSAT) {
                    gsatedWeightedSum += weighted;
                } else {
                    electiveWeightSum += weight;
                }
                
                const row = `
                    <tr style="${isGSAT ? 'color: #718096;' : 'font-weight: bold; color: #1a4d8c;'}">
                        <td>${subject}${isGSAT ? ' (å­¸æ¸¬)' : ' (åˆ†ç§‘)'}</td>
                        <td>${score}</td>
                        <td>x${weight}</td>
                        <td>${weighted.toFixed(1)}</td>
                    </tr>
                `;
                
                if (!showMissingOnly) {
                    usedHTML += row;
                }
            }

            const targetTotal = dept["æ™®é€šç”ŸéŒ„å–åˆ†æ•¸"];
            const gap = targetTotal - myTotal;
            
            // è¨ˆç®—åˆ†ç§‘å¹³å‡æ‰€éœ€ç´šåˆ†
            let targetAnalysisHTML = '';
            if (gap > 0) {
                if (electiveWeightSum > 0) {
                    const neededFromElective = targetTotal - gsatedWeightedSum;
                    const avgNeeded = neededFromElective / electiveWeightSum;
                    
                    targetAnalysisHTML = `
                        <div style="margin-top:15px; padding:12px; background:#fff5f5; border-left:4px solid #f56565; border-radius:4px;">
                            <strong style="color:#c53030;">ğŸ¯ éŒ„å–ç›®æ¨™åˆ†æï¼š</strong><br>
                            â€¢ æ‰£é™¤å­¸æ¸¬åŠ æ¬Šå¾Œï¼Œåˆ†ç§‘éœ€è£œè¶³ï¼š<strong>${neededFromElective.toFixed(1)}</strong> åˆ†<br>
                            â€¢ åˆ†ç§‘ç§‘ç›®å¹³å‡æ¯ç´šåˆ†éœ€é”ï¼š<span style="font-size:1.2rem; color:#e53e3e;">${avgNeeded.toFixed(2)}</span> ç´šåˆ†<br>
                            (â€¼ï¸ä»¥ä¸Šè¨ˆç®—åƒ…ä¾›åƒè€ƒ)
                        </div>
                    `;
                } else {
                    targetAnalysisHTML = `<div style="margin-top:10px; color:#e53e3e;">âš  æ­¤ç³»çµ„åƒ…æ¡è¨ˆå­¸æ¸¬ç§‘ç›®ï¼Œç›®å‰ç¸½åˆ†ä¸è¶³ã€‚</div>`;
                }
            } else {
                targetAnalysisHTML = `
                    <div style="margin-top:15px; padding:12px; background:#f0fff4; border-left:4px solid #48bb78; border-radius:4px;">
                        <strong style="color:#2f855a;">ğŸ‰ ç›®å‰åˆ†æ•¸å·²é”æ¨™ï¼</strong><br>
                        ä¿æŒåˆ†ç§‘æ¸¬é©—æ°´æº–å³å¯éŒ„å–ã€‚
                    </div>
                `;
            }

            return `
                <h4>ğŸ“‹ è©³ç´°è¨ˆç®—èˆ‡ç›®æ¨™åˆ†æ</h4>
                <table class="calc-table">
                    <tr>
                        <th>ç§‘ç›®</th>
                        <th>ä½ çš„æˆç¸¾</th>
                        <th>åŠ æ¬Š</th>
                        <th>åŠ æ¬Šå¾Œå¾—åˆ†</th>
                    </tr>
                    ${usedHTML}
                    <tr style="font-weight:700; background:#e2e8f0;">
                        <td colspan="3">ç›®å‰åŠ æ¬Šç¸½åˆ†</td>
                        <td>${myTotal.toFixed(1)}</td>
                    </tr>
                </table>
                <p style="margin-top:10px;">
                    ğŸ“Œ æœ€ä½éŒ„å–åˆ†æ•¸ï¼š${targetTotal}<br>
                    ğŸ“Œ ç›¸å·®åˆ†æ•¸ï¼š${gap > 0 ? `å°šå·® ${gap.toFixed(1)} åˆ†` : `é«˜å‡º ${Math.abs(gap).toFixed(1)} åˆ†`}
                </p>
                ${targetAnalysisHTML}
            `;
        }

        // æ¸²æŸ“ç§‘ç³»åˆ—è¡¨
        function renderDeptList(year) {
            const data = allData[year];
            if (!data) {
                document.getElementById('deptRows').innerHTML = '<div class="no-data">æš«ç„¡è©²å¹´åº¦è³‡æ–™</div>';
                return;
            }

            const searchText = document.getElementById('searchInput').value.toLowerCase();
            
            let filteredData = data.filter(dept => {
                // A. æ’é™¤ç©ºç™½ç„¡æ•ˆè³‡æ–™èˆ‡æ¨™é ­
                if (!dept["ç³»çµ„ä»£ç¢¼"] || dept["æ ¡å"] === "æ ¡å" || !dept["æ ¡å"]) return false;

                // B. æœå°‹éæ¿¾
                const fullName = `${dept["æ ¡å"]} ${dept["ç³»çµ„å"]}`.toLowerCase();
                if (searchText && !fullName.includes(searchText)) return false;

                // C. æ¡è¨ˆç§‘ç›®éæ¿¾ (ä½¿ç”¨è€…æ˜¯å¦æœ‰è¼¸å…¥å°æ‡‰æˆç¸¾)
                const weights = parseWeightString(dept["æ¡è¨ˆåŠåŠ æ¬Š"]);
                if (!shouldShowDept(weights)) return false;

                // D. å…¬ç§ç«‹éæ¿¾ (æ›´åš´è¬¹çš„åˆ¤å®š)
                const isPublic = dept["æ ¡å"].startsWith('åœ‹ç«‹') || 
                                dept["æ ¡å"].includes('å¸‚ç«‹') || 
                                dept["æ ¡å"].includes('ç¸£ç«‹');
                
                if (currentType === 'public' && !isPublic) return false;
                if (currentType === 'private' && isPublic) return false;

                // E. åªçœ‹éŒ„å–éæ¿¾ (èˆ‡ D åŒæ™‚ç”Ÿæ•ˆ)
                if (showOnlyPass) {
                    const gap = calculateGap(dept);
                    if (gap > 0) return false; // åˆ†æ•¸ä¸å¤ å°±ä¸é¡¯ç¤º
                }

                return true;
            });

            const container = document.getElementById('deptRows');
            if (filteredData.length === 0) {
                container.innerHTML = '<div class="no-data">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„ç§‘ç³»</div>';
                return;
            }

            // æ¸²æŸ“ HTML (é€™éƒ¨åˆ†ç¶­æŒä½ åŸæœ¬çš„è¿´åœˆé‚è¼¯)
            let htmlContent = '';
            filteredData.forEach(dept => {
                const deptId = `${year}-${dept["ç³»çµ„ä»£ç¢¼"]}`;
                const isExpanded = expandedRows.has(deptId);
                const gap = calculateGap(dept);
                const gapClass = gap <= 0 ? 'gap-negative' : 'gap-positive';
                const gapText = gap <= 0 ? `âœ… é«˜å‡º ${Math.abs(gap).toFixed(1)} åˆ†` : `å°šå·® ${gap.toFixed(1)} åˆ†`;
                const isInFavorites = favorites.some(f => f.id === deptId);
                const deptBase64 = btoa(unescape(encodeURIComponent(JSON.stringify(dept))));

                htmlContent += `
                    <div class="dept-row ${isExpanded ? 'expanded' : ''}" onclick="toggleDetail('${deptId}')">
                        <div>
                            <strong>${dept["æ ¡å"]}</strong><br>
                            <span style="font-size:0.9rem; color:#666;">${dept["ç³»çµ„å"]}</span>
                        </div>
                        <div style="font-size:0.9rem;">${formatSubjects(dept["æ¡è¨ˆåŠåŠ æ¬Š"])}</div>
                        <div>${dept["æ™®é€šç”ŸéŒ„å–åˆ†æ•¸"]}</div>
                        <div class="gap-value ${gapClass}">${gapText}</div>
                        <div onclick="event.stopPropagation()">
                            <button class="add-btn ${isInFavorites ? 'added' : ''}" 
                                    onclick="toggleFavorite('${deptId}', '${year}', '${deptBase64}')">
                                ${isInFavorites ? 'å·²åŠ å…¥' : 'åŠ å…¥æ¸…å–®'}
                            </button>
                        </div>
                    </div>
                    ${isExpanded ? `<div class="dept-detail">${generateDetailHTML(dept)}</div>` : ''}
                `;
            });

            container.innerHTML = htmlContent;
        }

        function toggleDetail(deptId) {
            if (expandedRows.has(deptId)) {
                expandedRows.delete(deptId);
            } else {
                expandedRows.add(deptId);
            }
            renderDeptList(currentYear);
        }

        function toggleFavorite(deptId, year, deptBase64) {
            // è§£ç¢¼ Base64 å›ç‰©ä»¶
            const dept = JSON.parse(decodeURIComponent(escape(atob(deptBase64))));
            
            const index = favorites.findIndex(f => f.id === deptId);
            
            if (index === -1) {
                favorites.push({
                    id: deptId,
                    year: year,
                    ...dept
                });
            } else {
                favorites.splice(index, 1);
            }
            
            localStorage.setItem('favorites', JSON.stringify(favorites));
            document.getElementById('favoritesCount').textContent = favorites.length;
            
            renderDeptList(currentYear);
            renderFavorites();
        }

        function removeFromFavorites(deptId) {
            favorites = favorites.filter(f => f.id !== deptId);
            localStorage.setItem('favorites', JSON.stringify(favorites));
            document.getElementById('favoritesCount').textContent = favorites.length;
            renderDeptList(currentYear);
            renderFavorites();
        }

        function loadFavorites() {
            const saved = localStorage.getItem('favorites');
            if (saved) {
                try {
                    favorites = JSON.parse(saved);
                } catch (e) {
                    favorites = [];
                }
            }
            document.getElementById('favoritesCount').textContent = favorites.length;
        }

        function renderFavorites() {
            const container = document.getElementById('favoritesList');
            
            // 1. å–å¾—æ”¶è—é é¢æœå°‹æ¡†çš„æ–‡å­—
            const favSearchText = document.getElementById('favSearchInput') ? document.getElementById('favSearchInput').value.toLowerCase() : '';
            
            // 2. å…ˆéæ¿¾å‡ºç¬¦åˆæœå°‹æ¢ä»¶çš„é …ç›®
            const filteredFavs = favorites.filter(dept => {
                const fullName = `${dept["æ ¡å"]} ${dept["ç³»çµ„å"]}`.toLowerCase();
                return fullName.includes(favSearchText);
            });

            // å¦‚æœå®Œå…¨æ²’æ”¶è—
            if (favorites.length === 0) {
                container.innerHTML = '<div style="color:#666; text-align:center; padding:20px;">ğŸ“Œ å°šç„¡è¿½è¹¤ç§‘ç³»</div>';
                return;
            }

            // å¦‚æœæœå°‹å¾Œæ²’çµæœ
            if (filteredFavs.length === 0) {
                container.innerHTML = `<div style="color:#666; text-align:center; padding:20px;">ğŸ” æ‰¾ä¸åˆ°ç›¸ç¬¦çš„ "${favSearchText}"</div>`;
                return;
            }

            // 3. ä½¿ç”¨éæ¿¾å¾Œçš„ filteredFavs é€²è¡Œæ¸²æŸ“ (åŸæœ¬æ˜¯ç”¨ favorites.map)
            container.innerHTML = filteredFavs.map((dept, index) => {
                const gap = calculateGap(dept);
                const gapClass = gap <= 0 ? 'gap-negative' : 'gap-positive';
                const gapText = gap <= 0 ? `âœ… é«˜å‡º ${Math.abs(gap).toFixed(1)} åˆ†` : `å°šå·® ${gap.toFixed(1)} åˆ†`;
                const isExpanded = favExpandedRows.has(dept.id);

                return `
                    <div class="favorite-item" onclick="toggleFavDetail('${dept.id}')" style="cursor: pointer; ${isExpanded ? 'background: #e6f0ff;' : ''}">
                        <div>
                            <strong>${dept["æ ¡å"]}</strong><br>
                            <span style="font-size:0.9rem;">${dept["ç³»çµ„å"]} (${dept.year})</span>
                        </div>
                        <div style="font-size:0.9rem;">${formatSubjects(dept["æ¡è¨ˆåŠåŠ æ¬Š"])}</div>
                        <div>${dept["æ™®é€šç”ŸéŒ„å–åˆ†æ•¸"]}</div>
                        <div class="gap-value ${gapClass}">${gapText}</div>
                        <div onclick="event.stopPropagation()" style="display: flex; gap: 5px; align-items: center;">
                            <button class="remove-btn" onclick="removeFromFavorites('${dept.id}')">ç§»é™¤</button>
                        </div>
                        ${isExpanded ? `<div class="favorite-detail" onclick="event.stopPropagation()">${generateDetailHTML(dept)}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        // æ–°å¢ï¼šåˆ‡æ›æ”¶è—æ¸…å–®å±•é–‹ç‹€æ…‹çš„å‡½å¼
        function toggleFavDetail(deptId) {
            if (favExpandedRows.has(deptId)) {
                favExpandedRows.delete(deptId);
            } else {
                favExpandedRows.add(deptId);
            }
            renderFavorites();
        }

        function moveFavorite(index, direction) {
            // index æ˜¯ç›®å‰ä½ç½®ï¼Œdirection ç‚º -1 (ä¸Šç§») æˆ– 1 (ä¸‹ç§»)
            const newIndex = index + direction;
            
            // æª¢æŸ¥æ˜¯å¦è¶…å‡ºé‚Šç•Œ
            if (newIndex < 0 || newIndex >= favorites.length) return;
            
            // äº¤æ›é™£åˆ—å…ƒç´ 
            const temp = favorites[index];
            favorites[index] = favorites[newIndex];
            favorites[newIndex] = temp;
            
            // å„²å­˜ä¸¦æ›´æ–°ç•«é¢
            localStorage.setItem('favorites', JSON.stringify(favorites));
            renderFavorites();
        }

        function togglePassFilter() {
            showOnlyPass = !showOnlyPass;
            const btn = document.getElementById('passFilterBtn');
            
            if (showOnlyPass) {
                btn.innerText = "åªçœ‹éŒ„å–";
                btn.classList.add('active'); // æ²¿ç”¨ä½ åŸæœ¬å¹´ä»½æŒ‰éˆ•çš„è—è‰²æ¨£å¼
            } else {
                btn.innerText = "é¡¯ç¤ºå…¨éƒ¨";
                btn.classList.remove('active');
            }
            
            renderDeptList(currentYear);
        }

        function filterByType(type) {
            currentType = type;
            
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            document.getElementById('type-all').classList.remove('active');
            document.getElementById('type-public').classList.remove('active');
            document.getElementById('type-private').classList.remove('active');
            
            document.getElementById('type-' + type).classList.add('active');
            
            // é‡æ–°æ¸²æŸ“åˆ—è¡¨
            renderDeptList(currentYear);
        }

        // åˆ¤å®šå…¬ç§ç«‹çš„è¼”åŠ©å‡½å¼
        function isPublicSchool(schoolName) {
            if (!schoolName) return false;
            // å°ç£å…¬ç«‹å¤§å­¸é€šå¸¸ä»¥ã€Œåœ‹ç«‹ã€ã€ã€Œå¸‚ç«‹ã€ã€ã€Œç¸£ç«‹ã€é–‹é ­ï¼Œæˆ–æ˜¯ã€Œåœ‹ç«‹ã€å­—çœ¼åœ¨æ ¡åå…§
            return schoolName.startsWith('åœ‹ç«‹') || 
                schoolName.includes('å¸‚ç«‹') || 
                schoolName.includes('ç¸£ç«‹');
        }

        function showPage(pageName) {
            const analysisPage = document.getElementById('page-analysis');
            const favoritesPage = document.getElementById('page-favorites');
            const tabAnalysis = document.getElementById('tab-analysis');
            const tabFavorites = document.getElementById('tab-favorites');

            if (pageName === 'analysis') {
                // é¡¯ç¤ºåˆ†æï¼Œéš±è—æ¸…å–®
                analysisPage.style.display = 'block';
                favoritesPage.style.display = 'none';
                // åˆ‡æ›æŒ‰éˆ•é¡è‰²
                tabAnalysis.classList.add('active');
                tabFavorites.classList.remove('active');
            } else {
                // éš±è—åˆ†æï¼Œé¡¯ç¤ºæ¸…å–®
                analysisPage.style.display = 'none';
                favoritesPage.style.display = 'block';
                // åˆ‡æ›æŒ‰éˆ•é¡è‰²
                tabAnalysis.classList.remove('active');
                tabFavorites.classList.add('active');
                // åˆ‡æ›åˆ°æ¸…å–®é æ™‚ï¼Œå¼·åˆ¶é‡æ–°åˆ·æ–°æ¸…å–®å…§å®¹
                renderFavorites();
            }
        }

        // å•Ÿå‹•
        init();
    </script>
</body>
</html>